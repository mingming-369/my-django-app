{% extends 'insurance_app/base.html' %}

{% block title %}Details for {{ customer.customer_name }}{% endblock %}

{% block page_title %}Customer Details{% endblock %}

{% block content %}
<div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-5xl mx-auto">
         <div class="border-b pb-6 mb-6 flex justify-between items-start">
                <div>
                    <h1 class="text-3xl font-bold text-gray-800">{{ customer.customer_name }}</h1>
                    <p class="text-gray-500 font-mono">ID: {{ customer.id_customer }}</p>
                </div>
                <div class="flex space-x-2">
                    {% if perms.insurance_app.change_customer %}
                        <a href="{% url 'edit_customer' customer.id_customer %}" class="bg-blue-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-blue-600">Edit</a>
                    {% endif %}
                    {% if perms.insurance_app.delete_customer %}
                        <a href="{% url 'delete_customer' customer.id_customer %}" class="bg-red-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-red-600">Delete</a>
                    {% endif %}
                </div>
            </div>

            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 text-gray-700 mb-10">
                <div><p class="font-semibold">Address:</p><p>{{ customer.address|default:"N/A" }}</p></div>
                <div><p class="font-semibold">Email:</p><p>{{ customer.email|default:"N/A" }}</p></div>
                <div><p class="font-semibold">Phone Number:</p><p>{{ customer.phone_num|default:"N/A" }}</p></div>
                
                <div>
                    <p class="font-semibold">In Charge By:</p>
                    <p>{{ customer.in_charge_person|default:"Not Assigned" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Proposal Prepared By:</p>
                    <p>{{ customer.proposal_prepared_by|default:"Not Assigned" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Engineers:</p>
                    <p>{{ customer.engineers|default:"Not Assigned" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Installer:</p>
                    <p>{{ customer.installer|default:"Not Assigned" }}</p>
                </div>
                <div>
                    <p class="font-semibold">Installed On:</p>
                    <p>{{ customer.installed_on|date:"F d, Y"|default:"N/A" }}</p>
                </div>
            </div>

            {% if perms.insurance_app.add_customerfile or perms.insurance_app.delete_customerfile or perms.insurance_app.view_customerfile %}
            <div class="bg-white p-8 rounded-lg shadow-2xl w-full max-w-5xl mx-auto">
                <div class="mb-10">
                    <div class="flex justify-between items-center mb-4 border-t pt-6">
                        <h2 class="text-2xl font-bold text-gray-800">Customer Files</h2>
                    </div>
                    
                    {% if perms.insurance_app.add_customerfile %}
                    <form action="{% url 'upload_customer_file' customer.id_customer %}" method="post" enctype="multipart/form-data" class="bg-gray-50 p-6 rounded-lg mb-6">
                        {% csrf_token %}
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4 items-center">
                            <div>
                                <label for="file" class="block text-sm font-medium text-gray-700">Select File:</label>
                                <input type="file" name="file" id="file" required class="mt-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-full file:border-0 file:text-sm file:font-semibold file:bg-violet-50 file:text-violet-700 hover:file:bg-violet-100">
                            </div>
                            <div>
                                <label for="description" class="block text-sm font-medium text-gray-700">Description:</label>
                                <input type="text" name="description" id="description" class="mt-1 block w-full rounded-md border-gray-300 shadow-sm focus:border-indigo-300 focus:ring focus:ring-indigo-200 focus:ring-opacity-50">
                            </div>
                        </div>
                        <div class="mt-4 text-right">
                             <button type="submit" class="bg-blue-600 text-white font-semibold py-2 px-6 rounded-lg shadow-md hover:bg-blue-700 transition">Upload File</button>
                        </div>
                    </form>
                    {% endif %}

                    {% if customer_files %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-50">
                                <tr>
                                    <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Filename</th>
                                    <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Description</th>
                                    <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Uploaded At</th>
                                    {% if perms.insurance_app.delete_customerfile %}
                                        <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                    {% endif %}
                                </tr>
                            </thead>
                            <tbody>
                                {% for file in customer_files %}
                                <tr class="hover:bg-gray-50">
                                    <td class="py-2 px-3 border-b">
                                        <a href="{{ file.file.url }}" target="_blank" class="text-blue-600 hover:underline">{{ file.file.name|slice:"15:" }}</a>
                                    </td>
                                    <td class="py-2 px-3 border-b">{{ file.description }}</td>
                                    <td class="py-2 px-3 border-b">{{ file.uploaded_at|date:"Y-m-d H:i" }}</td>
                                    {% if perms.insurance_app.delete_customerfile %}
                                        <td class="py-2 px-3 border-b">
                                            <form action="{% url 'delete_customer_file' file.pk %}" method="post" class="inline">
                                                {% csrf_token %}
                                                <button type-="submit" 
                                                    class="text-red-600 hover:text-red-800 font-medium"
                                                    onclick="return confirm('Are you sure you want to delete this file?');">
                                                    Delete
                                                </button>
                                            </form>
                                        </td>
                                    {% endif %}
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                        <p class="text-gray-500">No files have been uploaded for this customer.</p>
                    {% endif %}
                </div>
             </div>
             {% endif %}
             
            {% if perms.insurance_app.view_insurance %}
            <div class="mb-10">
                <div class="flex justify-between items-center mb-4 border-t pt-6">
                    <h2 class="text-2xl font-bold text-gray-800">Insurance</h2>
                    {% if perms.insurance_app.add_insurance %}
                        <a href="{% url 'add_insurance' %}" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Add Insurance</a>
                    {% endif %}
                </div>
                {% if insurances %}
                    <div class="overflow-x-auto">
                        <table class="min-w-full bg-white border">
                            <thead class="bg-gray-50"><tr>
                                <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Status</th>
                                <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Policy</th>
                                <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Company</th>
                                <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">End Date</th>
                                {% if perms.insurance_app.change_insurance or perms.insurance_app.delete_insurance %}
                                    <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                                {% endif %}
                            </tr></thead>
                            <tbody>{% for ins in insurances %}
                            <tr class="hover:bg-gray-50">
                                <td class="py-2 px-3 border-b"><span class="h-3 w-3 rounded-full inline-block
                                    {% if ins.status_color == 'red' %} bg-red-500
                                    {% elif ins.status_color == 'yellow' %} bg-yellow-400
                                    {% else %} bg-green-500 {% endif %}"></span>
                                </td>
                                <td class="py-2 px-3 border-b">{{ ins.no_insurance }}</td>
                                <td class="py-2 px-3 border-b">{{ ins.ins_co }}</td>
                                <td class="py-2 px-3 border-b">{{ ins.end_period|date:"F d, Y" }}</td>
                                {% if perms.insurance_app.change_insurance or perms.insurance_app.delete_insurance %}
                                    <td class="py-2 px-3 border-b space-x-3">
                                        {% if perms.insurance_app.change_insurance %}
                                            <a href="{% url 'edit_insurance' ins.no_insurance %}" class="text-blue-600 hover:text-blue-800 font-medium">Edit</a>
                                        {% endif %}
                                        {% if perms.insurance_app.delete_insurance %}
                                            <a href="{% url 'delete_insurance' ins.no_insurance %}" class="text-red-600 hover:text-red-800 font-medium">Delete</a>
                                        {% endif %}
                                    </td>
                                {% endif %}
                            </tr>{% endfor %}</tbody>
                        </table>
                    </div>
                {% else %}
                    <p class="text-gray-500">This customer has no insurance policies on record.</p>
                {% endif %}
            </div>
            {% endif %}

            {% if perms.insurance_app.view_warranty %}
            <div class="mb-10">
                <div class="flex justify-between items-center mb-4 border-t pt-6">
                    <h2 class="text-2xl font-bold text-gray-800">Warranty</h2>
                    {% if perms.insurance_app.add_warranty %}
                        <a href="{% url 'add_warranty' customer.id_customer %}" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Add Warranty</a>
                    {% endif %}
                </div>
                {% if warranties %}
                    <div class="overflow-x-auto"><table class="min-w-full bg-white border">
                        <thead class="bg-gray-50"><tr>
                            <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Status</th>
                            <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Product</th>
                            <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">End Date</th>
                            {% if perms.insurance_app.change_warranty or perms.insurance_app.delete_warranty %}
                                <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                            {% endif %}
                        </tr></thead>
                        <tbody>{% for item in warranties %}
                        <tr class="hover:bg-gray-50">
                            <td class="py-2 px-3 border-b"><span class="h-3 w-3 rounded-full inline-block
                                {% if item.status_color == 'red' %} bg-red-500
                                {% elif item.status_color == 'yellow' %} bg-yellow-400
                                {% else %} bg-green-500 {% endif %}"></span>
                            </td>
                            <td class="py-2 px-3 border-b">{{ item.product_name }}</td>
                            <td class="py-2 px-3 border-b">{{ item.end_date|date:"F d, Y" }}</td>
                            {% if perms.insurance_app.change_warranty or perms.insurance_app.delete_warranty %}
                                <td class="py-2 px-3 border-b space-x-3">
                                    {% if perms.insurance_app.change_warranty %}
                                        <a href="{% url 'edit_warranty' item.warranty_id %}" class="text-blue-600 hover:text-blue-800 font-medium">Edit</a>
                                    {% endif %}
                                    {% if perms.insurance_app.delete_warranty %}
                                        <a href="{% url 'delete_warranty' item.warranty_id %}" class="text-red-600 hover:text-red-800 font-medium">Delete</a>
                                    {% endif %}
                                </td>
                            {% endif %}
                        </tr>{% endfor %}</tbody>
                    </table></div>
                {% else %}
                    <p class="text-gray-500">This customer has no warranties on record.</p>
                {% endif %}
            </div>
            {% endif %}

            {% if perms.insurance_app.view_defect %}
            <div>
                <div class="flex justify-between items-center mb-4 border-t pt-6">
                    <h2 class="text-2xl font-bold text-gray-800">Defect</h2>
                    {% if perms.insurance_app.add_defect %}
                        <a href="{% url 'add_defect' customer.id_customer %}" class="bg-green-500 text-white font-semibold py-2 px-4 rounded-lg hover:bg-green-600">Add Defect</a>
                    {% endif %}
                </div>
                {% if defects %}
                    <div class="overflow-x-auto"><table class="min-w-full bg-white border">
                        <thead class="bg-gray-50"><tr>
                            <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Status</th>
                            <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Start Date</th>
                            <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">End Date</th>
                            
                            {% if perms.insurance_app.change_defect or perms.insurance_app.delete_defect %}
                                <th class="py-2 px-3 border-b text-left text-sm font-semibold text-gray-600">Actions</th>
                            {% endif %}
                        </tr></thead>
                        <tbody>{% for item in defects %}
                        <tr class="hover:bg-gray-50">
                             <td class="py-2 px-3 border-b"><span class="h-3 w-3 rounded-full inline-block
                                {% if item.status_color == 'red' %} bg-red-500
                                {% elif item.status_color == 'yellow' %} bg-yellow-400
                                {% else %} bg-green-500 {% endif %}"></span>
                            </td>
                            <td class="py-2 px-3 border-b">{{ item.report_date|date:"F d, Y" }}</td>
                            <td class="py-2 px-3 border-b">{{ item.resolution_deadline|date:"F d, Y" }}</td>
                            
                            {% if perms.insurance_app.change_defect or perms.insurance_app.delete_defect %}
                                <td class="py-2 px-3 border-b space-x-3">
                                    {% if perms.insurance_app.change_defect %}
                                        <a href="{% url 'edit_defect' item.defect_id %}" class="text-blue-600 hover:text-blue-800 font-medium">Edit</a>
                                    {% endif %}
                                    {% if perms.insurance_app.delete_defect %}
                                        <a href="{% url 'delete_defect' item.defect_id %}" class="text-red-600 hover:text-red-800 font-medium">Delete</a>
                                    {% endif %}
                                </td>
                            {% endif %}
                        </tr>{% endfor %}</tbody>
                    </table></div>
                {% else %}
                    <p class="text-gray-500">This customer has no defect liability periods recorded.</p>
                {% endif %}
            </div>
            {% endif %}

            <div class="text-center mt-8 border-t pt-6">
                <a href="{% url 'customer_list' %}" class="text-blue-600 hover:text-blue-800 font-medium">&larr; Back to Customer List</a>
            </div>
        </div>
    </div>
{% endblock %}